## Install Singularity: https://github.com/apptainer/singularity/blob/master/INSTALL.md

Bootstrap: docker
From: condaforge/mambaforge

%files
    pipeline /fastqwiper
    run_wiping.sh /fastqwiper

%environment
    PATH=$PATH:/tmp/jre1.8.0_161/bin/

%post
    mamba config --set channel_priority strict
    mamba install python=3.10
    mamba install -c conda-forge -c bioconda snakemake=7.32.3 -y
    mamba install -c conda-forge colorama click -y
    mamba install -c bioconda trimmomatic -y

    mamba install -y -c bfxcss -c conda-forge fastqwiper

    # apt-config dump | grep Sandbox::User
    # cat <<EOF > /etc/apt/apt.conf.d/sandbox-disable

    apt-get update -y
    apt-get install gzrt -y

    # Software versions
    BBMAP_VER="39.01"

    wget -c https://sourceforge.net/projects/bbmap/files/BBMap_$BBMAP_VER.tar.gz/download -O /fastqwiper/BBMap_$BBMAP_VER.tar.gz
    cd fastqwiper
    tar -xvzf BBMap_${BBMAP_VER}.tar.gz
    rm BBMap_${BBMAP_VER}.tar.gz 

    wget -c http://javadl.oracle.com/webapps/download/AutoDL?BundleId=230532_2f38c3b165be4555a1fa6e98c45e0808 -O /tmp/java.tar.gz
    cd /tmp/
	tar xvzf java.tar.gz

    chmod 777 /fastqwiper/run_wiping.sh

%runscript
    if [ $# -ne 4 ]; then
        echo "You must provide four arguments"
        exit 1
    fi

    mode="$1"
    cores="$2"
    sample_name="$3"
    chunk_size="$4"

    cd /fastqwiper
    exec run_wiping.sh $@